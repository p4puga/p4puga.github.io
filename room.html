<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style2.css">
<link rel="icon" type="image/png" href="pajak.webp">
<title>SigmaGame Room</title>
<style>
    .chatroom p {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 5px 0;
    }
    .chatroom img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
    }
    .player-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 5px;
    }
    .player {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .player img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
</style>
</head>
<body>
<header><h1 id="roomHeader">SigmaGame</h1></header>
<main>
<section class="game">
    <h2>Gracze</h2>
    <div class="player-list" id="playerList"></div>
</section>
<section class="chat">
    <div class="Chatting"><p>Chat</p></div>
    <div class="chatroom" id="chatroom"></div>
    <input type="text" id="message" placeholder="Type a message">
    <button id="sendBtn">Send</button>
</section>
</main>
<footer><p>©2025 SigmaGame BETA</p></footer>

<script>
const urlParams = new URLSearchParams(window.location.search);
const roomID = urlParams.get('roomID') || 'defaultRoom';
const username = urlParams.get('username') || 'Guest';

// Lista avatarów na serwerze
const avatarList = [
    'avatars/1.jpg',
    'avatars/2.jpg',
    'avatars/3.jpg',
    'avatars/4.jpg',
    'avatars/5.jpg',
    'avatars/6.jpg',
    'avatars/7.jpg',
    'avatars/8.jpg',
    'avatars/9.jpg'
];

// Funkcja losująca avatar dla gracza
function assignAvatar(user) {
    let rooms = JSON.parse(localStorage.getItem('rooms') || '{}');
    if(!rooms[roomID].players) rooms[roomID].players = {};
    if(!rooms[roomID].players[user]) {
        const avatar = avatarList[Math.floor(Math.random() * avatarList.length)];
        rooms[roomID].players[user] = avatar;
        localStorage.setItem('rooms', JSON.stringify(rooms));
    }
    return rooms[roomID].players[user];
}

// Dołączenie gracza do pokoju
function joinRoom() {
    let rooms = JSON.parse(localStorage.getItem('rooms') || '{}');
    if(!rooms[roomID]) rooms[roomID] = {messages: [], players: {}};
    assignAvatar(username);
}

// Aktualizacja widoku czatu i listy graczy
function updateRoomView() {
    let rooms = JSON.parse(localStorage.getItem('rooms') || '{}');
    const room = rooms[roomID];
    if(!room) return;

    const chatroom = document.getElementById('chatroom');
    const isAtBottom = chatroom.scrollTop + chatroom.clientHeight >= chatroom.scrollHeight - 10;
    chatroom.innerHTML = room.messages.map(msg => {
        // jeśli avatar nie istnieje dla jakiegoś gracza (awaryjnie)
        if(!room.players[msg.user]) {
            room.players[msg.user] = avatarList[Math.floor(Math.random() * avatarList.length)];
            localStorage.setItem('rooms', JSON.stringify(rooms));
        }
        return `<p><img src="${room.players[msg.user]}"> <strong>${msg.user}:</strong> ${msg.text}</p>`;
    }).join('');
    if(isAtBottom) chatroom.scrollTop = chatroom.scrollHeight;

    const playerList = document.getElementById('playerList');
    playerList.innerHTML = Object.entries(room.players).map(([user, avatar]) =>
        `<div class="player"><img src="${avatar}"><span>${user}</span></div>`
    ).join('');
}

// Wysyłanie wiadomości
function sendMessage() {
    const messageInput = document.getElementById('message');
    const text = messageInput.value.trim();
    if(!text) return;
    let rooms = JSON.parse(localStorage.getItem('rooms') || '{}');
    rooms[roomID].messages.push({user: username, text});
    localStorage.setItem('rooms', JSON.stringify(rooms));
    messageInput.value = '';
    updateRoomView();
}

// Usunięcie gracza po zamknięciu karty
window.addEventListener('beforeunload', () => {
    let rooms = JSON.parse(localStorage.getItem('rooms') || '{}');
    if(rooms[roomID] && rooms[roomID].players[username]) {
        delete rooms[roomID].players[username];
        localStorage.setItem('rooms', JSON.stringify(rooms));
    }
});

// Obsługa przycisku i enter
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('message').addEventListener('keypress', e => { if(e.key==='Enter') sendMessage(); });

// Nagłówek pokoju
document.getElementById('roomHeader').textContent = `SigmaGame - ${roomID}`;

// Start
joinRoom();
updateRoomView();

// Odświeżanie co 1 sekundę
setInterval(() => {
    joinRoom();
    updateRoomView();
}, 1000);

// Nasłuchiwanie zmian w localStorage w innych kartach
window.addEventListener('storage', updateRoomView);
</script>
</body>
</html>
